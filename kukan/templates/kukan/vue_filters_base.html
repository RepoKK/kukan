<script>
const vModelComputed = {
  get() {
    return this.value;
  },
  set(newValue) {
    this.$emit('input', newValue);
  }
};
</script>


<script type="text/x-template" id="trigger-button">
    <div class="buttons has-addons">
        <span class="button is-selected" v-bind:class="{'is-primary':state}">[[cur_title]]</span>
        <span class="button" v-bind:class="{'is-primary':state}" @click.stop="rm_fil">
            <b-icon icon="close" size="is-small"></b-icon>
        </span>
    </div>
</script>
<script>
var Trigger = {
    props: ['title', 'current', 'state', 'keep_title'],
    computed: {
        cur_title: function () {
            res = ""
            if (this.current=='') {
                res = this.title
            } else {
                if (this.keep_title) {
                    res = this.title+': '+this.current
                } else {
                    res = this.current
                }
            }
            return res
        }
      },
    methods: {
        rm_fil: function () {
            this.$emit('rm_fil')
        }
    },
    template: '#trigger-button'
}
</script>


<script type="text/x-template" id="drop-down-top">
    <b-dropdown-item custom>
        <nav class="level is-mobile" style="font-size:1rem;">
            <!-- Left side -->
            <div class="level-left">
                <p class="level-item"><strong>[[title]]</strong></p>
            </div>
            <!-- Right side -->
            <div class="level-right">
                <a class="button is-primary" @click="handleApply">適用</a>
            </div>
        </nav>
    </b-dropdown-item>
</script>
<script>
var DropDownTop = {
        data() {
            return {
                _isDropdown: true // Used internally by DropdownItem
            }
        },
    props: ['title'],
    methods: {
        handleApply: function () {
            this.$parent.selectItem(this)
            this.$emit('apply')
        }
    },
    template: '#drop-down-top'
}
</script>




<script type="text/x-template" id="fr-filter-template">
    <div>
        <b-dropdown ref="dropDn" @keyup.enter.native="enterApply">
            <fr-trigger slot="trigger" :title="title" :current="current_filter|truncate(18)" :keep_title="keep_title"
                        :state="is_active" @rm_fil="$emit('rm_fil')"></fr-trigger>
            <drop-down-top :title="title" v-on:apply="handleApply"></drop-down-top>
            <slot></slot>
        </b-dropdown>
    </div>
</script>
<script>
Vue.component('fr-filter', {
    data: function () {
        return {
        }
    },
    components: {
        'fr-trigger': Trigger,
        'drop-down-top': DropDownTop,
    },
    computed: {
        is_active: function () {return (this.current_filter!='')}
      },
    props: {
        title:String,
        current_filter:String,
        keep_title:{type:Boolean, default:false}
        },
    methods: {
        handleApply: function (filter_val) {
            this.$emit('apply')
        },
        enterApply: function () {
            this.handleApply()
            this.$refs.dropDn.toggle()
        },
    },
    filters: {
        truncate(value, length) {
            return value.length > length
                ? value.substr(0, length) + '...'
                : value
        }
    },
    template: '#fr-filter-template'
})
</script>

<script>
var MixinFrBase = {
    data: function () {
        return {
            filter: ""
        }
    },
    props: ['title', 'idx', 'extra', 'value'],
    created() {
        this.tempFilter = this.value
        this.filter = this.tempFilter
    },
    methods: {
        handleApply: function (filter_val) {
            this.filter=this.tempFilter
            this.$emit('input', this.filter)
        },
        rm_fil: function () {
            this.$emit('rm_fil', this.idx)
        }
    },
}
</script>



<script type="text/x-template" id="fr-filter-string-template">
    <fr-filter v-on:apply="handleApply" @rm_fil="rm_fil"
               :title="title" :current_filter="filter" :keep_title="true">
        <b-dropdown-item custom><b-field>
            <b-input :placeholder="placeholder"
                        v-model="localValue">
            </b-input>
        </b-field></b-dropdown-item>
    </fr-filter>
</script>
<script>
Vue.component('fr-filter-string', {
    mixins: [MixinFrBase],
    template: '#fr-filter-string-template',
    props: ['placeholder'],
    data: function () {
        return {
            localValue: ""
        }
    },
    computed: {
        tempFilter: {
            get: function () {
                return this.localValue
            },
            set: function (newVal) {
                this.localValue = newVal
            }
        }
    },
})
</script>
