<script>

const vModelComputed = {
  get() {
    return this.value;
  },
  set(newValue) {
    this.$emit('input', newValue);
  }
};
</script>




<script type="text/x-template" id="trigger-button">
    <div class="buttons has-addons">
        <span class="button is-selected" v-bind:class="{'is-primary':state}">[[cur_title]]</span>
        <span class="button" v-bind:class="{'is-primary':state}" @click.stop="rm_fil">
            <b-icon icon="close" size="is-small"></b-icon>
        </span>
    </div>
</script>
<script>
var Trigger = {
    props: ['title', 'current', 'state', 'keep_title'],
    computed: {
        cur_title: function () {
            res = ""
            if (this.current=='') {
                res = this.title
            } else {
                if (this.keep_title) {
                    res = this.title+': '+this.current
                } else {
                    res = this.current
                }
            }
            return res
        }
      },
    methods: {
        rm_fil: function () {
            this.$emit('rm_fil')
        }
    },
    template: '#trigger-button'
}
</script>


<script type="text/x-template" id="drop-down-top">
    <b-dropdown-item custom>
        <nav class="level is-mobile">
            <!-- Left side -->
            <div class="level-left">
                <p class="level-item"><strong>[[title]]</strong></p>
            </div>
            <!-- Right side -->
            <div class="level-right">
                <a class="button is-primary" @click="handleApply">適用</a>
            </div>
        </nav>
    </b-dropdown-item>
</script>
<script>
var DropDownTop = {
        data() {
            return {
                _isDropdown: true // Used internally by DropdownItem
            }
        },
    props: ['title'],
    methods: {
        handleApply: function () {
            this.$parent.selectItem(this)
            this.$emit('apply')
        }
    },
    template: '#drop-down-top'
}
</script>


<script type="text/x-template" id="drop-down-min-max">
    <b-dropdown-item custom><b-field>
        <b-input :placeholder="placeholder"
                    type="number"
                    :min="min"
                    :max="max"
                    v-model="localValue">
        </b-input>
        <p class="control">
            <a class="button is-static">
                [[label]]
            </a>
        </p>
    </b-field></b-dropdown-item>
</script>
<script>
var Kakusu = {
    data: function () {
        return {
            _isDropdown: true, // Used internally by DropdownItem
        }
    },
    props: ['value', 'label', 'placeholder', 'min', 'max'],
    computed: {
        localValue: vModelComputed
      },
    template: '#drop-down-min-max',
}
</script>


<script type="text/x-template" id="fr-filter-template">
    <div>
        <b-dropdown ref="dropDn" @keyup.enter.native="enterApply">
            <fr-trigger slot="trigger" :title="title" :current="current_filter|truncate(18)" :keep_title="keep_title"
                        :state="is_active" @rm_fil="$emit('rm_fil')"></fr-trigger>
            <drop-down-top :title="title" v-on:apply="handleApply"></drop-down-top>
            <slot></slot>
        </b-dropdown>
    </div>
</script>
<script>
Vue.component('fr-filter', {
    data: function () {
        return {
        }
    },
    components: {
        'fr-trigger': Trigger,
        'drop-down-top': DropDownTop,
    },
    computed: {
        is_active: function () {return (this.current_filter!='')}
      },

    props: {
        title:String,
        current_filter:String,
        keep_title:{type:Boolean, default:false}
        },
    methods: {
        handleApply: function (filter_val) {
            this.$emit('apply')
        },
        enterApply: function () {
            this.handleApply()
            this.$refs.dropDn.toggle()
        },
    },
    filters: {
        truncate(value, length) {
            return value.length > length
                ? value.substr(0, length) + '...'
                : value
        }
    },
    template: '#fr-filter-template'
})
</script>

<script>
var MixinFrBase = {
    data: function () {
        return {
            filter: ""
        }
    },
    props: ['title', 'value'],
    created() {
        if (this.value != '') {
            this.tempFilter = this.value
            this.filter = this.tempFilter
        }
    },
    methods: {
        handleApply: function (filter_val) {
            this.filter=this.tempFilter
            this.$emit('input', this.filter)
        },
    },
}
</script>


<script type="text/x-template" id="fr-filter-yomi-template">
    <fr-filter v-on:apply="handleApply" @rm_fil="$emit('rm_fil')"
               :title="title" :current_filter="filterDisp" :keep_title="true">
        <b-dropdown-item custom>
                <b-input :placeholder="placeholder" v-model="localValue"></b-input>
        </b-dropdown-item>
        <b-dropdown-item custom>
            <div style="width:300px;">
                <b-radio v-model="matchPosition" native-value="位致">と一致する</b-radio>
                <b-radio v-model="matchPosition" native-value="位始">から始まる</b-radio>
                <b-radio v-model="matchPosition" native-value="位含">を含む</b-radio>
            </div>
        </b-dropdown-item>
        <b-dropdown-item separator></b-dropdown-item>
        <b-dropdown-item custom><strong>音訓読み</strong></b-dropdown-item>
        <b-dropdown-item custom>
            <div style="width:300px;">
                <b-radio v-model="matchOnKun" native-value="読両">両方</b-radio>
                <b-radio v-model="matchOnKun" native-value="読音">音読み</b-radio>
                <b-radio v-model="matchOnKun" native-value="読訓">訓読み</b-radio>
            </div>
        </b-dropdown-item>
        <b-dropdown-item separator></b-dropdown-item>
        <b-dropdown-item custom><strong>常用漢字表</strong></b-dropdown-item>
        <b-dropdown-item custom>
            <div style="width:300px;">
                <b-radio v-model="matchJoyo" native-value="常全">全読み</b-radio>
                <b-radio v-model="matchJoyo" native-value="常用">常用読み</b-radio>
                <b-radio v-model="matchJoyo" native-value="常外">常用読み以外</b-radio>
            </div>
        </b-dropdown-item>
    </fr-filter>
</script>
<script>
Vue.component('fr-filter-yomi', {
    mixins: [MixinFrBase],
    template: '#fr-filter-yomi-template',
    props: ['placeholder'],
    data: function () {
        return {
            localValue: "",
            matchPosition: "位致",
            matchOnKun: "読両",
            matchJoyo: "常全"
        }
    },
    computed: {
        filterDisp: function() {
            [val, pos, onkun, joyo] = this.filter.split('_');
            var extra = []
            if (pos == '位始') {extra.push('始')}
            if (pos == '位含') {extra.push('含')}
            if (onkun == '読音') {extra.push('音')}
            if (onkun == '読訓') {extra.push('訓')}
            if (joyo == '常用') {extra.push('常用')}
            if (joyo == '常外') {extra.push('常外')}
            if (extra != '') {val += ' (' + extra.join('/') + ')'}
            return val
        },
        tempFilter: {
            get: function () {
                const flt = [
                    `${this.localValue}`,
                    `${this.matchPosition}`,
                    `${this.matchOnKun}`,
                    `${this.matchJoyo}`
                ].join('_')
                return flt
            },
            set: function (newVal) {
                [this.localValue, this.matchPosition, this.matchOnKun, this.matchJoyo] = newVal.split('_')
            }
        }
    },
})

</script>


<script type="text/x-template" id="fr-filter-string-template">
    <fr-filter v-on:apply="handleApply" @rm_fil="$emit('rm_fil')"
               :title="title" :current_filter="filter" :keep_title="true">
        <b-dropdown-item custom><b-field>
            <b-input :placeholder="placeholder"
                        v-model="localValue">
            </b-input>
        </b-field></b-dropdown-item>
    </fr-filter>
</script>
<script>
Vue.component('fr-filter-string', {
    mixins: [MixinFrBase],
    template: '#fr-filter-string-template',
    props: ['placeholder'],
    data: function () {
        return {
            localValue: ""
        }
    },
    computed: {
        tempFilter: {
            get: function () {
                return this.localValue
            },
            set: function (newVal) {
                this.localValue = newVal
            }
        }
    },
})

</script>

<script type="text/x-template" id="fr-filter-min-max-template">
    <fr-filter v-on:apply="handleApply" @rm_fil="$emit('rm_fil')"
               :title="title" :current_filter="filter" :keep_title="true">
                    <fr-kakusu label="画以上" :placeholder="title" v-model="strokes.min"></fr-kakusu>
                    <fr-kakusu label="画以下" :placeholder="title" v-model="strokes.max"></fr-kakusu>
    </fr-filter>
</script>
<script>
function convPosInt(str) {
    strInt = parseInt(str, 10)
    res = ''
    if (str == strInt && strInt >= 0) {
        res = strInt
    }
    return res
}

Vue.component('fr-filter-min-max', {
    mixins: [MixinFrBase],
    template: '#fr-filter-min-max-template',
    components: {
        'fr-kakusu': Kakusu,
    },

    data: function () {
        return {
            strokes: {
                min: null,
                max: null,
            }
        }
    },

    computed: {
        tempFilter: {
            get: function () {
                res = ''
                if (this.strokes.min != null || this.strokes.max != null) {
                    res = this.strokes.min  + '~' + this.strokes.max
                }
                return res
            },
            set: function (newVal) {
                val = newVal.split('~')
                if (val.length == 2) {
                    this.strokes.min = convPosInt(val[0], 10)
                    this.strokes.max = convPosInt(val[1], 10)
                }
            }
        }
    },
})

</script>


<script type="text/x-template" id="fr-filter-checkbox-template">

    <fr-filter v-on:apply="handleApply" @rm_fil="$emit('rm_fil')" :title="title" :current_filter="filter">
        <b-dropdown-item custom>
            <div class="columns is-mobile">
                <div class="column">
                    <div v-for="(elem, index) in col0" class="field">
                        <component :is="comptype" v-model="checkboxGroup" :native-value=elem.index>[[elem.label]]</component>
                    </div>
                </div>
                <div class="column" v-if="col1.length>0">
                    <div v-for="(elem, index) in col1" class="field">
                        <component :is="comptype" v-model="checkboxGroup" :native-value=elem.index>[[elem.label]]</component>
                    </div>
                </div>
            </div>
        </b-dropdown-item>
        <b-dropdown-item v-if="comptype=='b-checkbox'" separator></b-dropdown-item>
        <b-dropdown-item v-if="comptype=='b-checkbox'" custom>
            <div class="columns is-mobile">
                <div class="column">
                    <b-checkbox v-model="selectAll">全選択</b-checkbox>
                </div>
            </div>
        </b-dropdown-item>
    </fr-filter>
</script>
<script>
Vue.component('fr-filter-checkbox', {
    mixins: [MixinFrBase],
    template: '#fr-filter-checkbox-template',
    props: ['elements', 'comptype'],

    data: function () {
        return {
            checkboxGroup: ""
        }
    },

    computed: {
        selectAll: {
            get: function() {
                return this.checkboxGroup.length == this.elements.length
            },
            set: function (value) {
                var selected = [];

                if (value) {
                    this.elements.forEach(function (elem) {
                        selected.push(elem.index);
                    });
                    this.checkboxGroup = selected;
                } else {
                    if (this.checkboxGroup.length == this.elements.length) {
                        this.checkboxGroup = [];
                    }
                }
            }
        },
        col0: function() {
            return this.indexedElem.filter(function(u) {
                return u.col == 0 || u.col == null
            })
        },
        col1: function() {
            return this.indexedElem.filter(function(u) {
                return u.col == 1
            })
        },
        indexedElem: function() {
            return this.elements.map((obj,idx) => {obj.index = idx; return obj;})
        },
        tempFilter: {
            get: function () {
                res = ""
                if (this.comptype == 'b-checkbox' && this.checkboxGroup.length>0) {
                    lst_label = []
                    for (var i = 0, len = this.checkboxGroup.length; i < len; i++) {
                        lst_label.push(this.elements[this.checkboxGroup[i]].label)
                        res = lst_label.join(", ")
                    }
                } else if (this.comptype == 'b-radio' && this.checkboxGroup != undefined){
                    res = this.elements[this.checkboxGroup].label
                }
                return res
            },
            set: function (newVal) {
                var res = []
                val = this.value.split(', ')
                for (var i = 0, len = this.elements.length; i < len; i++) {
                    if (val.indexOf(this.elements[i].label) > -1 ) {
                        res.push(i)
                    }
                }
                if (this.comptype == 'b-radio') {
                    res = res[0]
                }
                this.checkboxGroup = res
            }
        },
    },
})

</script>

<script>
var MixinFrComp = {
    data: function () {
        return {
            compValue: this.value
        }
    },
    props: ['title', 'idx', 'value'],
    methods: {
        rm_fil: function () {
            this.$emit('rm_fil', this.idx)
        }
    },
    watch: {
        'compValue': function(val, oldVal){
            this.$emit('input', this.compValue)
        }
    }
}
</script>